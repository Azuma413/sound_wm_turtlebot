# 音源定位シミュレーション環境の実装説明

## 概要

本実装は、音源定位タスクのための強化学習環境を提供します。環境内でロボットは音源の位置を推定しながら移動し、正確な音源位置の推定と効率的な探索を学習することができます。

## クラス構成

### WrapDrQ

DrQv2アルゴリズム用のラッパークラスです。

#### 主要メソッド
- `reset()`: 環境を初期化し、観測を返します
- `step(action)`: 行動を実行し、結果を返します
- `observation_spec()`: 観測空間の仕様を返します
- `action_spec()`: 行動空間の仕様を返します

### MySimulator

音源定位のシミュレーション環境を提供するクラスです。

#### 主要パラメータ
- `fs`: サンプリングレート (16000Hz)
- `nfft`: FFTサイズ (256)
- `freq_range`: 推定する周波数帯域 [300Hz, 3500Hz]
- `sound_height`: 音源の高さ (1.3m)
- `robot_height`: ロボットの高さ (0.3m)
- `mic_num`: マイクロフォンアレイの数 (8)
- `move_range`: ロボットの移動範囲 (0.2m)

#### 主要メソッド
- `coord2pixel()`: ROS座標系から画像座標系への変換
- `pixel2coord()`: 画像座標系からROS座標系への変換
- `update_robot_pos()`: ロボットの位置を更新
- `simulate()`: 音響シミュレーションを実行

### MyEnv

強化学習用の環境クラスです。

#### 主要パラメータ
- `action_space`: 行動空間 (-1.0から1.0の2次元連続値)
- `observation_space`: 観測空間 (128x128x3のRGB画像)
- `max_episode_steps`: 最大エピソード長 (100ステップ)
- `confidence_threshold`: 音源存在判定の閾値 (0.7)
- `distribution_reward_weight`: 分布報酬の重み (0.4)

#### 主要メソッド
- `reset()`: 環境を初期化
  - ロボットと音源の位置をランダムに設定
  - シミュレーションを実行し初期観測を返す

- `step(action)`: 行動を実行
  - ロボットの位置を更新
  - シミュレーションを実行
  - 報酬を計算
  - 新しい観測を返す

- `render()`: 環境の可視化
  - マップの描画
  - ロボットの位置の描画
  - 音源の位置の描画
  - 推定結果の描画
  - 報酬値の表示

## 報酬設計

報酬は以下の2つの要素から構成されています：

1. 分布報酬 (重み: 0.4)
   - 音源の存在確率分布の収束度合いに基づく報酬
   - 確率が閾値を超えるピクセル数が少ないほど高い報酬

2. 推定報酬 (重み: 0.6)
   - 推定された音源位置と実際の音源位置との距離に基づく報酬
   - 距離が近いほど高い報酬

負の報酬（ペナルティ）は以下の場合に与えられます：
- 音源を見失った場合 (-1.0)
- 壁に衝突した場合 (-1.0)

## 観測空間

観測は128x128x3のRGB画像として提供されます：
- Rチャンネル: 音源の存在確率分布
- Gチャンネル: 環境のマップ情報
- Bチャンネル: ロボットの位置情報

## 行動空間

行動は2次元の連続値（-1.0から1.0）で表現されます：
- 1次元目: 前後方向の移動
- 2次元目: 左右方向の移動

## シミュレーション詳細

音響シミュレーションには以下の特徴があります：
- pyroomacousticsを使用した音響伝播シミュレーション
- 最大3次の反射まで考慮
- MUSICアルゴリズムによるDOA（到来方向）推定
- 円形マイクロフォンアレイ（半径3.5cm）の使用
- 可変な部屋形状（長方形、L字型、仕切りあり）の対応
